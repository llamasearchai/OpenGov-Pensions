[tox]
envlist =
    py{311,312,313}-linux
    py{311,312,313}-macos
    py{311,312,313}-windows
    lint,type,security
skip_missing_interpreters = true

[testenv]
deps = -e .[test]
commands =
    python -m pytest -v --tb=short --cov=opengovpension --cov-report=term-missing --cov-report=xml --cov-fail-under=85
setenv =
    PYTHONPATH = {toxinidir}/src
    COVERAGE_FILE = {toxinidir}/.coverage.{envname}

[testenv:lint]
deps = -e .[dev]
commands =
    ruff check src tests
    black --check --diff src tests
    isort --check-only --diff src tests

[testenv:type]
deps = -e .[dev]
commands =
    mypy src
    pyright src

[testenv:security]
deps =
    bandit>=1.7.9
    safety>=3.2.5
    pip-audit>=2.7.3
commands =
    bandit -r src -f json -o bandit-report.json
    safety check --json --output safety-report.json
    pip-audit --format json --output pip-audit-report.json

[testenv:format]
deps = -e .[dev]
commands =
    black src tests
    isort src tests
    ruff check --fix src tests

[testenv:coverage]
deps = -e .[test]
commands =
    python -m pytest --cov=opengovpension --cov-report=html --cov-report=term-missing
    coverage combine
    coverage report --fail-under=90

[testenv:performance]
deps =
    -e .[test]
    locust>=2.20.1
commands =
    locust -f tests/performance/locustfile.py --headless -u 50 -r 5 -t 60s

[testenv:docs]
deps = -e .[docs]
commands =
    mkdocs build --clean --strict

[testenv:clean]
deps =
commands =
    find . -type f -name "*.pyc" -delete
    find . -type d -name "__pycache__" -delete
    find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
    rm -rf .coverage* .tox/ htmlcov/ .pytest_cache/ .mypy_cache/ .ruff_cache/

[gh-actions]
python =
    3.11: py311
    3.12: py312
    3.13: py313

[gh-actions:env]
OS =
    ubuntu-latest: linux
    macos-latest: macos
    windows-latest: windows